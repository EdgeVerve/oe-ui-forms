<script>
  var OEUtils = OEUtils || {};
  OEUtils.DraftImpl = {
    properties: {
      draftId: {
        type: String,
        observer: '_draftIdChanged'
      },
      _draftConfig: {
        type: Object,
        value: function () {
          return {
            componentProps: [],
            options: {}
          }
        }
      }
    },
    attached: function () {
      this.use('postInsert', this.deleteDraft);
    },
    _draftIdChanged: function (oldVal, newVal) {
      if (this.draftId) {
        this.loadDraft(this.draftId);
      }
    },
    loadDraft: function (id, next) {
      var modelAlias = this.modelAlias;
      this.makeAjaxCall('api/DraftData/' + id, 'GET', null, null, null, null, function (err, resp) {
        if (err) {
          this.resolveError(err);
        } else {
          this.draftInstance = resp;
          this.set(modelAlias, resp.modelData);
          if (!this.isObjectEmpty(resp.componentData)) {
            Object.keys(resp.componentData).forEach(function (key) {
              this.set(key, resp.componentData[key])
            }.bind(this))
          }
          this.fire('oe-show-success', 'Draft loaded saved successfully.');
          if (next) {
            next()
          }
        }
      }.bind(this));
    },
    _getComponentData: function () {
      if (this._draftConfig && this._draftConfig.componentProps && Array.isArray(this._draftConfig.componentProps)) {
        var obj = {};
        this._draftConfig.componentProps.forEach(function (prop) {
          obj[prop] = this[prop]
        }.bind(this));
        return obj;
      } else {
        return {}
      }
    },
    _getDraftOptions: function () {
      if (this._draftConfig && this._draftConfig.options) {
        return this._draftConfig.options;
      } else {
        return {}
      }
    },
    saveDraft: function (componentData, options, next) {
      componentData = componentData || this._getComponentData();
      options = options || this._getDraftOptions();
      var modelAlias = this.modelAlias;
      var instance = this[modelAlias];
      var body = {
        "formName": this.is,
        "modelData": instance,
        "componentData": componentData,
        "options": options
      }

      if (this.draftInstance && !this.isObjectEmpty(this.draftInstance)) {
        body.id = this.draftInstance.id;
        body._version = this.draftInstance._version;
      }
      var method = this.draftInstance && this.draftInstance.id ? 'PUT' : 'POST';

      this.makeAjaxCall('api/DraftData', method, body, null, null, null, function (err, resp) {
        if (err) {
          this.resolveError(err);
        } else {
          this.fire('oe-draft-saved');
          this.set('draftInstance', resp);
          if (next) {
            next()
          }
        }
      }.bind(this));
    },

    deleteDraft: function (response, instance, next) {
      if (this.draftInstance && !this.isObjectEmpty(this.draftInstance)) {
        var url = 'api/DraftData/' + this.draftInstance.id;
        this.makeAjaxCall(url, 'delete', null, null, null, null, function (err, resp) {
          if (err) {
            this.resolveError(err);
          } else {
            this.fire('oe-draft-deleted');
          }
        }.bind(this));
      }
      next(null, response);
    },

    isObjectEmpty: function (obj) {
      return Object.keys(obj).length === 0 && this.obj.constructor === Object;
    }
  }
  OEUtils.DraftBehavior = [OEUtils.DraftImpl,
    OEUtils.AjaxBehavior,
    OEUtils.FormValidationBehavior,
    OEUtils.FormMessagesBehavior,
    OEUtils.ModelHandler
  ]

</script>
